{{- /*
  Converts local ".md" links into proper links (not supported out-of-the-box by Hugo).

  Also adds 'target="_blank"' to external links.

  Also fixes local links (i.e. to files other than images) that won't work out-of-the-box
  because we trim trailing slashes from URLs and thus relative links become invalid otherwise
  (i.e. the browser uses "../parent-folder/attach.zip" instead of "../parent-folder/my-article/attach.zip").

  Source:
  * https://github.com/bep/portable-hugo-links
  * https://github.com/bep/portable-hugo-links/blob/master/layouts/_default/_markup/render-link.html
*/ -}}

{{- $link := .Destination -}}
{{- $text := .Text -}}
{{- $openInNewTab := false -}}
{{- $cssClass := "" -}}

{{- if $link -}}
  {{- $compactUriMatch := findRESubmatch `^([a-zA-Z0-9]+):(.+)$` $link -}}
  {{- $compactUriPrefix := "" -}}

  {{- if ne (len $compactUriMatch) 0 -}}
    {{- /* Either a regular external link or a compact URI link. */ -}}
    {{- $compactUriPrefix = index (index $compactUriMatch 0) 1 -}}
    {{- $openInNewTab = true -}}
    {{- $cssClass = "external" -}}

    {{- if not (strings.HasPrefix $compactUriPrefix "http") -}}

      {{- /*
        It's an actual compact uri.
        NOTE: This is based on the proposed CURIE draft (https://en.wikipedia.org/wiki/CURIE) which unfortunately
          isn't supported by browsers (as of Dec 2023).
      */ -}}
      {{- $compactUris := site.Params.compactUris -}}
      {{- $baseCompactUri := index $compactUris $compactUriPrefix -}}
      {{- if $baseCompactUri -}}
        {{- $link = printf "%s%s" $baseCompactUri (index (index $compactUriMatch 0) 2) -}}
      {{- else -}}
        {{- warnf "Page '%v': Compact URI prefix '%v' is not defined (for '%v')." .Page.File.Path $compactUriPrefix .Destination -}}
      {{- end -}}

    {{- end -}}
  {{- else -}}

    {{- with .Page.Resources.GetMatch .Destination -}}
      {{- /* Resource, not a page. */ -}}
      {{- $link = .RelPermalink -}}
      {{- $cssClass = printf "resource resource-%s" .ResourceType -}}

      {{- if eq .ResourceType "text" -}}
        {{- /* Make sure the browser doesn't "overwrite" the current page with the resource. */ -}}
        {{- $openInNewTab = true -}}
      {{- end -}}

    {{- else -}}
      {{- /* Parse URL to get URL without fragment (e.g. "#my-anchor"): $url.Path */ -}}
      {{- $url := urls.Parse $link -}}

      {{- /* Check if .Destination actually points to another page and isn't just a fragment (e.g. just "#my-anchor"). */ -}}
      {{- if $url.Path -}}

      {{- $cssClass = "page" -}}
        {{- with site.GetPage $url.Path -}}
          {{- $fragment := "" -}}
          {{- with $url.Fragment -}}
            {{- /* Prefix fragment with # */ -}}
            {{- $fragment = printf "#%s" . -}}
          {{- end -}}
          {{- $link = printf "%s%s" (strings.TrimSuffix "/" .RelPermalink) $fragment -}}
        {{- else -}}
          {{- warnf "Page '%v': Could not locate link target '%v'." .Page.File.Path .Destination -}}
        {{- end -}}

      {{- else -}}
        {{- /* Just a fragment (e.g. just "#my-anchor"). */ -}}
        {{- $cssClass = "anchor" -}}
        {{- if not (.Page.Fragments.Identifiers.Contains $url.Fragment) -}}
          {{- warnf "Page '%v': Could not locate target anchor '%v'." .Page.File.Path .Destination -}}
        {{- else if not $text -}}
          {{- $targetHeading := index .Page.Fragments.HeadingsMap $url.Fragment -}}
          {{- $text = $targetHeading.Title -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

{{- else -}}
  {{- warnf "Page '%v': Found empty link." .Page.File.Path -}}
{{- end -}}

{{- if not $text -}}
  {{- /* Use destination as text if non is set. */ -}}
  {{- $text = htmlEscape .Destination -}}
{{- end -}}

<a href="{{ $link | safeURL }}" class="{{ $cssClass }}"{{ with .Title }} title="{{ . }}"{{ end }}{{ if $openInNewTab }} target="_blank"{{ end }}>{{ $text | safeHTML }}</a>