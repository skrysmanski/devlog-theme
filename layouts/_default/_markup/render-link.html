{{- /*
  Converts local ".md" links into proper links (not supported out-of-the-box by Hugo).

  Also adds 'target="_blank"' to external links.

  Also fixes local links (i.e. to files other than images) that won't work out-of-the-box
  because we trim trailing slashes from URLs and thus relative links become invalid otherwise
  (i.e. the browser uses "../parent-folder/attach.zip" instead of "../parent-folder/my-article/attach.zip").

  Source:
  * https://github.com/bep/portable-hugo-links
  * https://github.com/bep/portable-hugo-links/blob/master/layouts/_default/_markup/render-link.html
*/ -}}
{{- $link := .Destination -}}
{{- $isExternal := strings.HasPrefix $link "http" -}}
{{- if $link -}}
  {{- if not $isExternal -}}
    {{- with .Page.Resources.GetMatch .Destination -}}
      {{- /* Resource, not a page. */ -}}
      {{- $link = .RelPermalink -}}
    {{- else -}}
      {{- /* Parse URL to get URL without fragment (e.g. "#my-anchor"): $url.Path */ -}}
      {{- $url := urls.Parse $link -}}
      {{- /* Check if .Destination actually points to another page and isn't just a fragment (e.g. just "#my-anchor"). */ -}}
      {{- if $url.Path -}}
        {{- with site.GetPage $url.Path -}}
          {{- $fragment := "" -}}
          {{- with $url.Fragment -}}
            {{- /* Prefix fragment with # */ -}}
            {{- $fragment = printf "#%s" . -}}
          {{- end -}}
          {{- $link = printf "%s%s" (strings.TrimSuffix "/" .RelPermalink) $fragment -}}
        {{- else -}}
          {{- warnf "Page '%v': Could not locate link target '%v'." .Page.File.Path .Destination -}}
        {{- end -}}
      {{- else -}}
        {{- /* Just a fragment (e.g. just "#my-anchor"). */ -}}
        {{- if not (.Page.Fragments.Identifiers.Contains $url.Fragment) -}}
          {{- warnf "Page '%v': Could not locate target anchor '%v'." .Page.File.Path .Destination -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- else -}}
  {{- warnf "Page '%v': Found empty link." .Page.File.Path -}}
{{- end -}}
<a href="{{ $link | safeURL }}"{{ with .Title}} title="{{ . }}"{{ end }}{{ if $isExternal }} target="_blank"{{ end }}>{{ .Text | safeHTML }}</a>