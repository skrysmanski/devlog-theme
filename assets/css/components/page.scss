main.page {
  display: grid;

  // Defines the columns.
  // NOTE: minmax() is required to prevent the column to become too big. See: https://css-tricks.com/preventing-a-grid-blowout/
  //   I.e. if just using max($content-width), the column doesn't shrink if the available space is smaller.
  grid-template-columns: minmax(0, $content-width);
  @media (min-width: $toc_as_sidebar_width_threshold) { // screen is big enough
    grid-template-columns: minmax(0, $content-width) $toc-sidebar-width;
  }

  // This allows the TOC to be sticky.
  align-items: start;
}

main.page > header {
  grid-row: 1;
  grid-column: 1;

  #page-title {
    // NOTE: We replace "margin-top" with "padding-top" here so that "scroll-margin-top" doesn't create
    //   a difference between scrolling to this heading and scrolling to the top of the page.
    margin-top: 0;
    padding-top: 0.7em;

    margin-bottom: 0.5em;

    line-height: 1.3em;
  }

  .old-page {
    margin-top: 1.5em;
    background-color: #fff4a5;
    padding: $page-meta-padding;
    border-radius: $block-border-radius;
  }
}

main.page > article {
  grid-column: 1;
  grid-row: 3;

  @media (min-width: $toc_as_sidebar_width_threshold) { // screen is big enough
    grid-row: 2;
  }
}

//
// Page Content
//
#page-content {
  h2, h3, h4, h5, h6 {
    border-top: 1px solid #dfdfdf;
    margin-top: 2em;
    padding-top: 0.7em;

    // This is for the ":target" selector that changes the padding.
    transition: padding 0.35s;

    // NOTE: We make this always visible (we used to hide it and show only on hover) because
    //   this way it's easier to discover and it's also usable on mobile devices (where there
    //   is no hover).
    a.permalink {
      color: $permalink-color;
      font-size: 0.7em;
      text-decoration: none;

      &:hover {
        color: $link-color;
      }
    }
  }

  // Makes sure that there are no (vertical) gaps (via margins) between sections. If there are,
  // the IntersectionObserver won't know which section that margin belongs to (i.e. if you
  // scroll "wrong", no section in the ToC will be highlighted). To fix this, we remove all
  // margins and replace them with paddings.
  // NOTE: sections are only available if JavaScript is enabled.
  section {
    box-sizing: border-box;
    padding-top: 2em;

    & > h2, & > h3, & > h4, & > h5, & > h6 {
      // NOTE: We move the margin from the h element to the outer section, so that "scroll-margin-top"
      //   works properly (i.e. creates a 2em gap between the header and the heading).
      margin-top: 0;
    }

    p:last-child {
      margin-bottom: 0;
    }
  }

  // Remove top border if there's no text/content between the primary title and the first h2 heading.
  // NOTE: Don't remove the top margin/padding so that "scroll-margin-top" works properly (i.e. still
  //   creates a 2em gap between the header and the heading).
  > h2:first-child, > section:first-child > h2 {
    border-top: none;
  }

  //
  // If the heading/section is targeted via "#...".
  //
  section:target {
    > h2, > h3, > h4, > h5, > h6 { // after sections have been created
      border-top: none;
      padding: 0.2em 0.6em;
      background-color: $heading-background-target;
      border-radius: $block-border-radius;

      a.permalink {
        color: $permalink-color-target;
      }
    }
  }
  h2, h3, h4, h5, h6 { // before sections are created
    &:target {
      border-top: none;
      padding: 0.2em 0.6em;
      background-color: $heading-background-target;
      border-radius: $block-border-radius;

      a.permalink {
        color: $permalink-color-target;
      }
    }
  }


  blockquote {
    border-left: 6px solid #bbb;
    margin: 1em 0em;
    padding: .5em 1em;
    background: #eaeaea;

    p {
      margin: .5em 0;
    }
  }

  @import 'components/code_block';

  img {
    max-width: 100%;
  }
}


//
// Numbered headings
//
main.page-main-section #page-content {
  @include heading-numbers {
    color: $permalink-color;
    font-size: 0.5em;
    font-weight: normal;
  }
}


//
// TOC
//
main.page aside#page-toc {
  @media (min-width: $toc_as_sidebar_width_threshold) { // screen is big enough
    // magic, magic - makes the sidebar work without any JavaScript
    // NOTE: This doesn't work if both html and body use "overflow-x: hidden;".
    position: sticky;
    // margin to the browser window's top when scrolling
    top: 105px;
    grid-row: 1 / span 2;
    grid-column: 2;
    // push it down a little bit when at the top of the page
    margin-top: 15px;
    margin-left: $toc-sidebar-spacing;
  }
  @media (max-width: calc(#{$toc_as_sidebar_width_threshold} - 1px)) { // screen is too small
    position: fixed;
    right: 0;
    top: 65px;
    @media (min-width: $small-screen-width) {
      top: 85px;
    }
    z-index: $z-index-slide-in-toc;

    background-color: $background-color; // for slide in TOC - make it non-transparent

    padding: 1em;

    transform: translateX(100%);
    transition: transform .2s linear;

    &.is-expanded {
      transform: translateX(0);
    }
  }

  font-size: 0.8rem;

  // "What's on this page"
  header > h2 {
    font-weight: bold;
    margin: 0;
    font-size: 0.8em;
    border-bottom: 1px solid $toc-separator-color;
  }

  header {
    margin-bottom: 0.4em;
  }

  nav#TableOfContents {
    ul {
      padding-left: 1.5em;
      margin-bottom: 0;
      list-style-type: none;
    }

    a {
      display: block;

      color: $text-color;
      // NOTE: The main font looks better than the headings font here.
      font-family: $main-font;

      border-left: 2px solid $toc-separator-color;
      padding: 0.4em 1em;

      transition: background-color 0.35s ease-out, border-color 0.35s ease-out;
    }

    // Highlight the currently viewed section.
    // NOTE: Only do this if the TOC is displayed as a sidebar. If not, this may cause flickering especially on mobile.
    a[aria-current] {
      font-weight: bold;
      background-color: lighten($link-color, 45%);
      border-color: $link-color;
    }

    // Only the outer most list
    & > ul {
      padding-left: 0;
    }
  }
}
